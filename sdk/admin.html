<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>go-flagship ¬∑ Admin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        --bg: #050816;
        --bg-elevated: #0b1020;
        --bg-elevated-2: #111827;
        --border: #1f2937;
        --accent: #38bdf8;
        --accent-soft: rgba(56, 189, 248, 0.12);
        --danger: #f97373;
        --danger-soft: rgba(248, 113, 113, 0.12);
        --text: #e5e7eb;
        --text-soft: #9ca3af;
        --radius: 10px;
        --shadow: 0 18px 40px rgba(15, 23, 42, 0.8);
        --transition: 160ms ease-out;
        --font-sans: system-ui, -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Helvetica Neue',
          Arial, sans-serif;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        background: radial-gradient(circle at top, #0b1120 0, #020617 50%, #000 100%);
        color: var(--text);
        font-family: var(--font-sans);
        -webkit-font-smoothing: antialiased;
      }

      .layout {
        display: grid;
        grid-template-columns: minmax(0, 2fr) minmax(360px, 460px);
        min-height: 100vh;
      }

      @media (max-width: 960px) {
        .layout {
          grid-template-columns: minmax(0, 1fr);
        }
      }

      .panel {
        padding: 20px 24px 24px;
        border-right: 1px solid var(--border);
      }

      @media (max-width: 960px) {
        .panel {
          border-right: none;
          border-bottom: 1px solid var(--border);
        }
      }

      .panel-right {
        padding: 20px 24px 24px;
      }

      header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 18px;
      }

      .logo {
        width: 32px;
        height: 32px;
        border-radius: 999px;
        background: radial-gradient(
          circle at 30% 30%,
          #22c55e 0,
          #6ee7b7 20%,
          #0f172a 60%,
          #020617 100%
        );
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: #e5e7eb;
        font-size: 17px;
        font-weight: 700;
        box-shadow: 0 10px 30px rgba(34, 197, 94, 0.45);
      }

      h1 {
        font-size: 20px;
        font-weight: 600;
        letter-spacing: 0.02em;
        margin: 0;
      }

      .subtitle {
        font-size: 13px;
        color: var(--text-soft);
        margin-top: 2px;
      }

      .top-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 8px;
      }

      .search-filter-bar {
        margin-bottom: 12px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .search-row {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .search-input {
        flex: 1;
        padding: 8px 12px;
        border-radius: 8px;
        border: 1px solid rgba(31, 41, 55, 0.95);
        background: rgba(15, 23, 42, 0.96);
        color: var(--text);
        font-size: 13px;
        font-family: inherit;
        outline: none;
        transition: var(--transition);
      }

      .search-input:focus {
        border-color: rgba(56, 189, 248, 0.9);
        box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.6);
      }

      .search-input::placeholder {
        color: var(--text-soft);
      }

      .filter-row {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
      }

      .filter-select {
        padding: 6px 10px;
        border-radius: 8px;
        border: 1px solid rgba(31, 41, 55, 0.95);
        background: rgba(15, 23, 42, 0.96);
        color: var(--text);
        font-size: 12px;
        font-family: inherit;
        outline: none;
        transition: var(--transition);
        cursor: pointer;
      }

      .filter-select:focus {
        border-color: rgba(56, 189, 248, 0.9);
        box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.6);
      }

      .result-count {
        font-size: 12px;
        color: var(--text-soft);
        margin-left: auto;
      }

      .clear-filters-btn {
        padding: 5px 12px;
        font-size: 12px;
        background: rgba(15, 23, 42, 0.95);
        color: var(--text-soft);
        border: 1px solid rgba(31, 41, 55, 0.95);
        border-radius: 999px;
        cursor: pointer;
        transition: var(--transition);
      }

      .clear-filters-btn:hover {
        background: rgba(17, 24, 39, 0.96);
        color: var(--text);
      }

      .highlight {
        background-color: rgba(56, 189, 248, 0.3);
        color: var(--text);
        font-weight: 600;
      }

      /* Environment tabs */
      .env-tabs {
        display: flex;
        gap: 6px;
        margin-bottom: 12px;
        border-bottom: 1px solid var(--border);
        padding-bottom: 8px;
      }

      .env-tab {
        padding: 6px 16px;
        font-size: 13px;
        background: transparent;
        color: var(--text-soft);
        border: none;
        border-bottom: 2px solid transparent;
        cursor: pointer;
        transition: var(--transition);
        font-family: inherit;
        font-weight: 500;
      }

      .env-tab:hover {
        color: var(--text);
        background: rgba(15, 23, 42, 0.5);
      }

      .env-tab.active {
        color: var(--accent);
        border-bottom-color: var(--accent);
      }

      /* Main navigation tabs */
      .main-nav {
        display: flex;
        gap: 4px;
        margin-bottom: 12px;
        border-bottom: 1px solid var(--border);
      }

      .main-nav-tab {
        padding: 8px 20px;
        font-size: 14px;
        background: transparent;
        color: var(--text-soft);
        border: none;
        border-bottom: 3px solid transparent;
        cursor: pointer;
        transition: var(--transition);
        font-family: inherit;
        font-weight: 500;
      }

      .main-nav-tab:hover {
        color: var(--text);
        background: rgba(15, 23, 42, 0.5);
      }

      .main-nav-tab.active {
        color: var(--accent);
        border-bottom-color: var(--accent);
      }

      .view-content {
        display: none;
      }

      .view-content.active {
        display: block;
      }

      /* Audit log styles */
      .audit-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
      }

      .audit-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--text);
      }

      .audit-filters {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
        flex-wrap: wrap;
      }

      .audit-timeline {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .audit-entry {
        border-radius: 12px;
        background: linear-gradient(145deg, rgba(15, 23, 42, 0.97), rgba(2, 6, 23, 0.98));
        border: 1px solid rgba(31, 41, 55, 0.95);
        padding: 14px 16px;
        transition: var(--transition);
      }

      .audit-entry:hover {
        background: rgba(15, 23, 42, 0.9);
        border-color: rgba(56, 189, 248, 0.3);
      }

      .audit-entry-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 8px;
      }

      .audit-entry-time {
        font-size: 12px;
        color: var(--text-soft);
      }

      .audit-entry-action {
        font-size: 13px;
        font-weight: 600;
        color: var(--text);
        margin-top: 2px;
      }

      .audit-entry-resource {
        font-size: 12px;
        color: var(--accent);
        font-family: ui-monospace, SFMono-Regular, monospace;
        margin-top: 2px;
      }

      .audit-entry-status {
        font-size: 11px;
        padding: 3px 8px;
        border-radius: 999px;
      }

      .audit-entry-status.success {
        background: rgba(22, 163, 74, 0.16);
        color: #bbf7d0;
        border: 1px solid rgba(34, 197, 94, 0.45);
      }

      .audit-entry-status.error {
        background: rgba(248, 113, 113, 0.12);
        color: #fecaca;
        border: 1px solid rgba(248, 113, 113, 0.6);
      }

      .audit-entry-details {
        font-size: 12px;
        color: var(--text-soft);
        margin-top: 8px;
        padding-top: 8px;
        border-top: 1px solid rgba(31, 41, 55, 0.5);
      }

      .audit-pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 8px;
        margin-top: 16px;
      }

      .audit-pagination button {
        padding: 6px 12px;
        font-size: 12px;
      }

      .audit-pagination span {
        font-size: 12px;
        color: var(--text-soft);
      }

      .export-btn {
        padding: 6px 14px;
        font-size: 12px;
        background: rgba(15, 23, 42, 0.95);
        color: var(--text);
        border: 1px solid rgba(31, 41, 55, 0.95);
        border-radius: 8px;
        cursor: pointer;
        transition: var(--transition);
      }

      .export-btn:hover {
        background: rgba(17, 24, 39, 0.96);
        border-color: var(--accent);
      }

      .loading-spinner-container {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 40px;
      }

      .loading-spinner-large {
        width: 40px;
        height: 40px;
        border: 3px solid rgba(56, 189, 248, 0.3);
        border-radius: 50%;
        border-top-color: var(--accent);
        animation: spin 0.8s linear infinite;
      }

      .etag {
        font-size: 11px;
        color: var(--text-soft);
        padding: 4px 10px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: rgba(15, 23, 42, 0.8);
        max-width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .etag-label {
        font-weight: 500;
        color: #9ca3af;
        margin-right: 6px;
      }

      .badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        border-radius: 999px;
        font-size: 11px;
        padding: 4px 9px;
        background: #022c22;
        color: #6ee7b7;
        border: 1px solid rgba(16, 185, 129, 0.4);
      }

      .badge-dot {
        width: 6px;
        height: 6px;
        border-radius: 999px;
        background: #22c55e;
        box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.35);
      }

      .table-card {
        margin-top: 12px;
        border-radius: 16px;
        background: linear-gradient(145deg, rgba(15, 23, 42, 0.97), rgba(2, 6, 23, 0.98));
        border: 1px solid rgba(31, 41, 55, 0.95);
        box-shadow: var(--shadow);
        overflow: hidden;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }

      thead {
        background: rgba(15, 23, 42, 0.96);
      }

      th,
      td {
        padding: 8px 12px;
        text-align: left;
        border-bottom: 1px solid rgba(15, 23, 42, 0.85);
      }

      th {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #9ca3af;
        font-weight: 600;
        background: rgba(15, 23, 42, 0.9);
      }

      tbody tr {
        cursor: pointer;
        transition: var(--transition);
      }

      tbody tr:hover {
        background: rgba(15, 23, 42, 0.9);
      }

      tbody tr.selected {
        background: rgba(8, 47, 73, 0.8);
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 11px;
        padding: 3px 8px;
        border-radius: 999px;
      }

      .pill-green {
        background: rgba(22, 163, 74, 0.16);
        color: #bbf7d0;
        border: 1px solid rgba(34, 197, 94, 0.45);
      }

      .pill-red {
        background: rgba(248, 113, 113, 0.12);
        color: #fecaca;
        border: 1px solid rgba(248, 113, 113, 0.6);
      }

      .pill-env {
        background: rgba(37, 99, 235, 0.12);
        color: #bfdbfe;
        border: 1px solid rgba(59, 130, 246, 0.65);
      }

      .pill-text {
        max-width: 220px;
        text-overflow: ellipsis;
        white-space: nowrap;
        overflow: hidden;
      }

      .empty-state {
        padding: 24px 16px;
        text-align: center;
        color: var(--text-soft);
        font-size: 13px;
      }

      .code {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono',
          'Courier New', monospace;
        font-size: 12px;
        padding: 2px 6px;
        border-radius: 6px;
        background: rgba(15, 23, 42, 0.9);
        border: 1px solid rgba(31, 41, 55, 0.9);
      }

      /* Right side form */

      .card {
        border-radius: 16px;
        background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.18), transparent 55%),
          radial-gradient(circle at bottom right, rgba(34, 197, 94, 0.18), transparent 60%),
          rgba(15, 23, 42, 0.98);
        border: 1px solid rgba(31, 41, 55, 0.95);
        box-shadow: var(--shadow);
        padding: 16px 18px 18px;
      }

      .card-title-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        margin-bottom: 4px;
      }

      .card-title {
        font-size: 15px;
        font-weight: 600;
      }

      .chip-secondary {
        font-size: 11px;
        padding: 3px 7px;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.4);
        color: #cbd5f5;
        background: rgba(15, 23, 42, 0.8);
      }

      .field-group {
        margin-top: 12px;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .field-label {
        font-size: 11px;
        color: #9ca3af;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        font-weight: 600;
      }

      .field-row {
        display: flex;
        gap: 8px;
      }

      input[type='text'],
      select,
      textarea {
        width: 100%;
        padding: 7px 9px;
        border-radius: 8px;
        border: 1px solid rgba(31, 41, 55, 0.95);
        background: rgba(15, 23, 42, 0.96);
        color: var(--text);
        font-size: 13px;
        font-family: inherit;
        outline: none;
        transition: var(--transition);
      }

      input[type='text']:focus,
      select:focus,
      textarea:focus {
        border-color: rgba(56, 189, 248, 0.9);
        box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.6);
      }

      textarea {
        resize: vertical;
        min-height: 120px;
        max-height: 280px;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono',
          'Courier New', monospace;
        font-size: 12px;
        line-height: 1.4;
      }

      .switch-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        margin-top: 4px;
      }

      .switch-label {
        font-size: 13px;
        color: var(--text-soft);
      }

      .switch {
        position: relative;
        width: 40px;
        height: 22px;
      }

      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .slider {
        position: absolute;
        cursor: pointer;
        inset: 0;
        background-color: #111827;
        border-radius: 999px;
        transition: var(--transition);
        border: 1px solid rgba(31, 41, 55, 0.9);
      }

      .slider:before {
        position: absolute;
        content: '';
        height: 16px;
        width: 16px;
        left: 3px;
        top: 2px;
        border-radius: 999px;
        background-color: #6b7280;
        transition: var(--transition);
        box-shadow: 0 4px 10px rgba(15, 23, 42, 0.7);
      }

      .switch input:checked + .slider {
        background-color: rgba(22, 163, 74, 0.25);
        border-color: rgba(34, 197, 94, 0.7);
      }

      .switch input:checked + .slider:before {
        transform: translateX(16px);
        background-color: #bbf7d0;
      }

      .helper-text {
        font-size: 11px;
        color: var(--text-soft);
      }

      .small-cols {
        display: flex;
        gap: 8px;
      }

      .small-cols > div {
        flex: 1;
      }

      .status-bar {
        margin-top: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
      }

      .status-message {
        font-size: 12px;
        color: var(--text-soft);
      }

      .status-message span {
        font-family: ui-monospace, SFMono-Regular;
      }

      .status-message.error {
        color: #fecaca;
      }

      .status-message.success {
        color: #bbf7d0;
      }

      .btn-row {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        margin-top: 12px;
      }

      button {
        border: none;
        cursor: pointer;
        font-family: inherit;
        font-size: 13px;
        padding: 7px 14px;
        border-radius: 999px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: var(--transition);
        white-space: nowrap;
      }

      .btn-secondary {
        background: rgba(15, 23, 42, 0.95);
        color: var(--text-soft);
        border: 1px solid rgba(31, 41, 55, 0.95);
      }

      .btn-secondary:hover {
        background: rgba(17, 24, 39, 0.96);
      }

      .btn-primary {
        background: radial-gradient(circle at 10% 0, #38bdf8 0, #0ea5e9 30%, #0369a1 100%);
        color: white;
        box-shadow: 0 8px 20px rgba(56, 189, 248, 0.45);
      }

      .btn-primary:hover {
        filter: brightness(1.03);
        transform: translateY(-0.5px);
        box-shadow: 0 12px 26px rgba(56, 189, 248, 0.6);
      }

      .btn-primary:active {
        transform: translateY(0);
        box-shadow: 0 6px 18px rgba(56, 189, 248, 0.5);
      }

      .btn-danger {
        background: rgba(248, 113, 113, 0.12);
        color: #fecaca;
        border: 1px solid rgba(248, 113, 113, 0.6);
      }

      .btn-danger:hover {
        background: rgba(248, 113, 113, 0.18);
        border-color: rgba(248, 113, 113, 0.8);
      }

      /* Error banner styles */
      .error-banner {
        display: none;
        margin-top: 12px;
        padding: 12px 14px;
        border-radius: 10px;
        background: rgba(248, 113, 113, 0.12);
        border: 1px solid rgba(248, 113, 113, 0.4);
        animation: slideIn 0.2s ease-out;
      }

      .error-banner.visible {
        display: block;
      }

      .error-banner-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }

      .error-banner-title {
        font-size: 13px;
        font-weight: 600;
        color: #fecaca;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .error-banner-code {
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 4px;
        background: rgba(248, 113, 113, 0.2);
        color: #fca5a5;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      }

      .error-banner-message {
        font-size: 12px;
        color: #fecaca;
        margin-top: 6px;
      }

      .error-banner-fields {
        margin-top: 10px;
        padding-top: 8px;
        border-top: 1px solid rgba(248, 113, 113, 0.25);
      }

      .error-field-item {
        display: flex;
        align-items: flex-start;
        gap: 8px;
        margin-top: 6px;
        font-size: 12px;
      }

      .error-field-name {
        font-weight: 600;
        color: #fca5a5;
        min-width: 80px;
      }

      .error-field-message {
        color: #fecaca;
        flex: 1;
      }

      .error-banner-dismiss {
        background: transparent;
        border: none;
        color: #fca5a5;
        cursor: pointer;
        padding: 4px;
        font-size: 16px;
        line-height: 1;
        opacity: 0.7;
        transition: opacity 0.15s ease;
      }

      .error-banner-dismiss:hover {
        opacity: 1;
      }

      .error-banner-request-id {
        font-size: 10px;
        color: #f87171;
        margin-top: 8px;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
        opacity: 0.8;
      }

      /* Field error highlight */
      .field-error input,
      .field-error select,
      .field-error textarea {
        border-color: rgba(248, 113, 113, 0.8) !important;
        box-shadow: 0 0 0 1px rgba(248, 113, 113, 0.4) !important;
      }

      .field-error-text {
        font-size: 11px;
        color: #fca5a5;
        margin-top: 4px;
      }

      /* Success toast styles */
      .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 16px;
        border-radius: 10px;
        font-size: 13px;
        z-index: 1000;
        animation: slideIn 0.3s ease-out;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
      }

      .toast.success {
        background: rgba(22, 163, 74, 0.9);
        color: #bbf7d0;
        border: 1px solid rgba(34, 197, 94, 0.6);
      }

      .toast.error {
        background: rgba(220, 38, 38, 0.9);
        color: #fecaca;
        border: 1px solid rgba(248, 113, 113, 0.6);
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Loading spinner */
      .btn-loading {
        pointer-events: none;
        opacity: 0.7;
      }

      .spinner {
        display: inline-block;
        width: 14px;
        height: 14px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 0.8s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="layout">
      <!-- LEFT: Flags table -->
      <div class="panel">
        <header>
          <div class="logo">fg</div>
          <div>
            <h1>go-flagship ¬∑ Admin</h1>
            <div class="subtitle">Live view of feature flags with SSE updates</div>
          </div>
        </header>

        <!-- Main Navigation -->
        <div class="main-nav">
          <button type="button" class="main-nav-tab active" id="navTabFlags">
            Flags
          </button>
          <button type="button" class="main-nav-tab" id="navTabAudit">
            Audit Log
          </button>
        </div>

        <!-- Flags View -->
        <div class="view-content active" id="viewFlags">

        <div class="top-row">
          <div class="etag" id="etagDisplay">
            <span class="etag-label">ETag:</span>
            <span id="etagValue">‚Äî</span>
          </div>
          <div class="badge" id="sseStatus">
            <span class="badge-dot"></span>
            <span id="sseStatusText">SSE: connecting‚Ä¶</span>
          </div>
        </div>

        <!-- Environment Tabs -->
        <div class="env-tabs">
          <button type="button" class="env-tab" data-env="prod" id="envTabProd">
            Production
          </button>
          <button type="button" class="env-tab" data-env="staging" id="envTabStaging">
            Staging
          </button>
          <button type="button" class="env-tab" data-env="dev" id="envTabDev">
            Development
          </button>
        </div>

        <!-- Search & Filter Bar -->
        <div class="search-filter-bar">
          <div class="search-row">
            <input
              type="text"
              id="searchInput"
              class="search-input"
              placeholder="üîç Search flags by key or description..."
              autocomplete="off"
            />
          </div>
          <div class="filter-row">
            <select id="statusFilter" class="filter-select">
              <option value="">Status: All</option>
              <option value="enabled">Status: Enabled</option>
              <option value="disabled">Status: Disabled</option>
            </select>
            <select id="rolloutFilter" class="filter-select">
              <option value="">Rollout: All</option>
              <option value="full">Rollout: Full (100%)</option>
              <option value="partial">Rollout: Partial (&lt;100%)</option>
              <option value="off">Rollout: Off (0%)</option>
            </select>
            <select id="expressionFilter" class="filter-select">
              <option value="">Expression: All</option>
              <option value="with">With Expression</option>
              <option value="without">Without Expression</option>
            </select>
            <button type="button" id="clearFiltersBtn" class="clear-filters-btn">
              Clear filters
            </button>
            <span class="result-count" id="resultCount">Showing 0 flags</span>
          </div>
        </div>

        <div class="table-card">
          <table>
            <thead>
              <tr>
                <th style="width: 26%">Key</th>
                <th style="width: 10%">Env</th>
                <th style="width: 13%">Status</th>
                <th style="width: 36%">Config</th>
                <th style="width: 15%">Updated</th>
              </tr>
            </thead>
            <tbody id="flagsBody">
              <tr>
                <td colspan="5">
                  <div class="empty-state">
                    No flags loaded yet. Create one on the right and hit
                    <span class="code">Save flag</span>.
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <!-- End Flags View -->

      <!-- Audit View -->
      <div class="view-content" id="viewAudit">
        <div class="audit-header">
          <div class="audit-title">Audit Log</div>
          <button type="button" class="export-btn" id="exportAuditBtn">
            üì• Export CSV
          </button>
        </div>

        <div class="audit-filters">
          <select id="auditActionFilter" class="filter-select">
            <option value="">Action: All</option>
            <option value="upsert_flag">Create/Update Flag</option>
            <option value="delete_flag">Delete Flag</option>
            <option value="create_api_key">Create API Key</option>
            <option value="revoke_api_key">Revoke API Key</option>
          </select>
          <input
            type="text"
            id="auditResourceFilter"
            class="search-input"
            placeholder="Filter by resource (e.g., flags/prod/my_flag)"
            style="max-width: 300px;"
          />
          <button type="button" id="clearAuditFiltersBtn" class="clear-filters-btn">
            Clear filters
          </button>
        </div>

        <div id="auditTimeline" class="audit-timeline">
          <div class="loading-spinner-container">
            <div class="loading-spinner-large"></div>
          </div>
        </div>

        <div class="audit-pagination" id="auditPagination">
          <button type="button" class="btn-secondary" id="auditPrevBtn" disabled>
            Previous
          </button>
          <span id="auditPageInfo">Page 1</span>
          <button type="button" class="btn-secondary" id="auditNextBtn">
            Next
          </button>
        </div>
      </div>
      <!-- End Audit View -->
      </div>

      <!-- RIGHT: Editor -->
      <div class="panel-right">
        <div class="card">
          <div class="card-title-row">
            <div>
              <div class="card-title">Create / Update flag</div>
              <div class="subtitle" style="margin-top: 1px">
                Uses <span class="code">POST /v1/flags</span> and triggers SSE update
              </div>
            </div>
            <div class="chip-secondary" id="selectedFlagChip">New flag</div>
          </div>

          <!-- Error Banner -->
          <div class="error-banner" id="errorBanner">
            <div class="error-banner-header">
              <div class="error-banner-title">
                <span>‚ö†Ô∏è</span>
                <span id="errorBannerTitle">Error</span>
                <span class="error-banner-code" id="errorBannerCode"></span>
              </div>
              <button type="button" class="error-banner-dismiss" id="dismissError" title="Dismiss">√ó</button>
            </div>
            <div class="error-banner-message" id="errorBannerMessage"></div>
            <div class="error-banner-fields" id="errorBannerFields"></div>
            <div class="error-banner-request-id" id="errorBannerRequestId"></div>
          </div>

          <form id="flagForm">
            <div class="field-group" id="fieldGroupKey">
              <label class="field-label">Key</label>
              <input
                type="text"
                id="flagKey"
                placeholder="e.g. banner_message"
                autocomplete="off"
              />
              <div class="helper-text">
                Flag identifier. Click a row in the table to load its key here.
              </div>
              <div class="field-error-text" id="fieldErrorKey"></div>
            </div>

            <div class="field-group" id="fieldGroupEnv">
              <label class="field-label">Environment</label>
              <select id="flagEnv">
                <option value="prod">prod</option>
                <option value="staging">staging</option>
                <option value="dev">dev</option>
              </select>
              <div class="field-error-text" id="fieldErrorEnv"></div>
            </div>

            <div class="field-group" id="fieldGroupDesc">
              <label class="field-label">Description</label>
              <input
                type="text"
                id="flagDesc"
                placeholder="e.g. Homepage banner experiment"
                autocomplete="off"
              />
              <div class="field-error-text" id="fieldErrorDescription"></div>
            </div>

            <div class="field-group">
              <div class="switch-row">
                <div class="switch-label">Enabled</div>
                <label class="switch">
                  <input type="checkbox" id="flagEnabled" checked />
                  <span class="slider"></span>
                </label>
              </div>
            </div>

            <div class="field-group" id="fieldGroupConfig">
              <label class="field-label">Config (JSON)</label>
              <textarea id="flagConfig" spellcheck="false" autocomplete="off">
{ "text": "Hello world" }</textarea
              >
              <div class="helper-text">
                Must be valid JSON object. Example:
                <span class="code">{ "variant": "A", "limit": 10 }</span>
              </div>
              <div class="field-error-text" id="fieldErrorConfig"></div>
            </div>

            <div class="field-group small-cols">
              <div id="fieldGroupRollout">
                <label class="field-label">Rollout %</label>
                <input type="text" id="flagRollout" value="100" />
                <div class="field-error-text" id="fieldErrorRollout"></div>
              </div>
              <div>
                <label class="field-label">Admin API key</label>
                <input type="text" id="adminKey" value="admin-123" />
                <div class="helper-text">
                  Sent as <span class="code">Authorization: Bearer &lt;key&gt;</span>
                </div>
              </div>
            </div>

            <div class="status-bar">
              <div id="formStatus" class="status-message">Ready.</div>
            </div>

            <div class="btn-row">
              <button type="button" class="btn-secondary" id="newFlagBtn">New flag</button>
              <button type="button" class="btn-secondary btn-danger" id="deleteFlagBtn">Delete flag</button>
              <button type="submit" class="btn-primary" id="saveBtn">Save flag</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Toast container -->
    <div id="toastContainer"></div>

    <script>
      // Determine API_BASE dynamically: use ?api_base=... query param if present, else hardcoded localhost:8080
      function getApiBase() {
        const params = new URLSearchParams(window.location.search);
        const apiBaseParam = params.get('api_base');
        if (apiBaseParam) {
          // Validate the URL format
          try {
            const url = new URL(apiBaseParam);
            // Only allow http and https protocols
            if (url.protocol !== 'http:' && url.protocol !== 'https:') {
              console.warn('Invalid api_base protocol, falling back to default');
              return 'http://localhost:8080';
            }
            return apiBaseParam;
          } catch (e) {
            console.warn('Invalid api_base URL format, falling back to default');
            return 'http://localhost:8080';
          }
        }
        return 'http://localhost:8080';
      }
      const API_BASE = getApiBase();
      const flagsBody = document.getElementById('flagsBody');
      const etagValue = document.getElementById('etagValue');
      const sseStatusText = document.getElementById('sseStatusText');
      const sseStatusEl = document.getElementById('sseStatus');
      const formStatus = document.getElementById('formStatus');
      const selectedFlagChip = document.getElementById('selectedFlagChip');

      const form = document.getElementById('flagForm');
      const keyInput = document.getElementById('flagKey');
      const envSelect = document.getElementById('flagEnv');
      const descInput = document.getElementById('flagDesc');
      const enabledInput = document.getElementById('flagEnabled');
      const configInput = document.getElementById('flagConfig');
      const rolloutInput = document.getElementById('flagRollout');
      const adminKeyInput = document.getElementById('adminKey');
      const newFlagBtn = document.getElementById('newFlagBtn');

      let currentSnapshot = null;
      let selectedKey = null;
      let selectedEnv = null;
      let es = null;

      // Search and filter state
      let searchQuery = '';
      let statusFilter = '';
      let rolloutFilter = '';
      let expressionFilter = '';
      let selectedEnvironment = 'prod'; // Default environment

      // Get filter elements
      const searchInput = document.getElementById('searchInput');
      const statusFilterSelect = document.getElementById('statusFilter');
      const rolloutFilterSelect = document.getElementById('rolloutFilter');
      const expressionFilterSelect = document.getElementById('expressionFilter');
      const clearFiltersBtn = document.getElementById('clearFiltersBtn');
      const resultCount = document.getElementById('resultCount');

      // Get environment tab elements
      const envTabProd = document.getElementById('envTabProd');
      const envTabStaging = document.getElementById('envTabStaging');
      const envTabDev = document.getElementById('envTabDev');
      const envTabs = [envTabProd, envTabStaging, envTabDev];

      // Get main navigation elements
      const navTabFlags = document.getElementById('navTabFlags');
      const navTabAudit = document.getElementById('navTabAudit');
      const viewFlags = document.getElementById('viewFlags');
      const viewAudit = document.getElementById('viewAudit');

      // Audit log state
      let auditLogs = [];
      let auditCurrentPage = 1;
      let auditLimit = 20;
      let auditTotalCount = 0;
      let auditActionFilter = '';
      let auditResourceFilter = '';

      // Get audit elements
      const auditTimeline = document.getElementById('auditTimeline');
      const auditPrevBtn = document.getElementById('auditPrevBtn');
      const auditNextBtn = document.getElementById('auditNextBtn');
      const auditPageInfo = document.getElementById('auditPageInfo');
      const auditActionFilterSelect = document.getElementById('auditActionFilter');
      const auditResourceFilterInput = document.getElementById('auditResourceFilter');
      const clearAuditFiltersBtn = document.getElementById('clearAuditFiltersBtn');
      const exportAuditBtn = document.getElementById('exportAuditBtn');

      function setStatus(message, kind = 'info') {
        formStatus.textContent = message;
        formStatus.classList.remove('error', 'success');
        if (kind === 'error') formStatus.classList.add('error');
        else if (kind === 'success') formStatus.classList.add('success');
      }

      // Error banner elements
      const errorBanner = document.getElementById('errorBanner');
      const errorBannerTitle = document.getElementById('errorBannerTitle');
      const errorBannerCode = document.getElementById('errorBannerCode');
      const errorBannerMessage = document.getElementById('errorBannerMessage');
      const errorBannerFields = document.getElementById('errorBannerFields');
      const errorBannerRequestId = document.getElementById('errorBannerRequestId');
      const dismissErrorBtn = document.getElementById('dismissError');
      const saveBtn = document.getElementById('saveBtn');

      // Field error elements
      const fieldGroups = {
        key: { group: document.getElementById('fieldGroupKey'), error: document.getElementById('fieldErrorKey') },
        env: { group: document.getElementById('fieldGroupEnv'), error: document.getElementById('fieldErrorEnv') },
        description: { group: document.getElementById('fieldGroupDesc'), error: document.getElementById('fieldErrorDescription') },
        config: { group: document.getElementById('fieldGroupConfig'), error: document.getElementById('fieldErrorConfig') },
        rollout: { group: document.getElementById('fieldGroupRollout'), error: document.getElementById('fieldErrorRollout') }
      };

      // Clear all field errors
      function clearFieldErrors() {
        Object.values(fieldGroups).forEach(({ group, error }) => {
          if (group) group.classList.remove('field-error');
          if (error) {
            error.textContent = '';
            error.style.display = 'none';
          }
        });
      }

      // Set field error
      function setFieldError(fieldName, message) {
        const field = fieldGroups[fieldName];
        if (field) {
          if (field.group) field.group.classList.add('field-error');
          if (field.error) {
            field.error.textContent = message;
            field.error.style.display = 'block';
          }
        }
      }

      // Show error banner with structured error response
      function showErrorBanner(errorResponse, httpStatus) {
        clearFieldErrors();
        hideErrorBanner();

        // Set banner content
        errorBannerTitle.textContent = errorResponse.error || 'Error';
        errorBannerCode.textContent = errorResponse.code || '';
        errorBannerCode.style.display = errorResponse.code ? 'inline' : 'none';
        errorBannerMessage.textContent = errorResponse.message || 'An error occurred';

        // Handle field-level errors
        if (errorResponse.fields && Object.keys(errorResponse.fields).length > 0) {
          errorBannerFields.style.display = 'block';
          errorBannerFields.innerHTML = Object.entries(errorResponse.fields).map(([field, msg]) => {
            // Also highlight the field in the form
            setFieldError(field, msg);
            return `<div class="error-field-item">
              <span class="error-field-name">${escapeHtml(field)}:</span>
              <span class="error-field-message">${escapeHtml(msg)}</span>
            </div>`;
          }).join('');
        } else {
          errorBannerFields.style.display = 'none';
          errorBannerFields.innerHTML = '';
        }

        // Show request ID if available
        if (errorResponse.request_id) {
          errorBannerRequestId.textContent = `Request ID: ${errorResponse.request_id}`;
          errorBannerRequestId.style.display = 'block';
        } else {
          errorBannerRequestId.style.display = 'none';
        }

        // Handle special status codes
        handleSpecialStatusCodes(httpStatus, errorResponse);

        errorBanner.classList.add('visible');
      }

      // Hide error banner
      function hideErrorBanner() {
        errorBanner.classList.remove('visible');
        clearFieldErrors();
      }

      // Handle special HTTP status codes
      function handleSpecialStatusCodes(status, errorResponse) {
        switch (status) {
          case 401:
            errorBannerTitle.textContent = 'üîí Authentication Failed';
            errorBannerMessage.textContent = errorResponse.message || 'Please check your API key and try again.';
            break;
          case 403:
            errorBannerTitle.textContent = 'üö´ Access Denied';
            errorBannerMessage.textContent = errorResponse.message || 'You do not have permission to perform this action.';
            break;
          case 429:
            errorBannerTitle.textContent = '‚è∞ Rate Limited';
            errorBannerMessage.textContent = 'Too many requests. Please wait a moment and try again.';
            break;
          case 500:
          case 502:
          case 503:
            errorBannerTitle.textContent = '‚ö†Ô∏è Server Error';
            errorBannerMessage.textContent = 'A server error occurred. Please try again later.';
            break;
        }
      }

      // Escape HTML to prevent XSS
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // Show toast notification
      function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        document.getElementById('toastContainer').appendChild(toast);
        
        setTimeout(() => {
          toast.style.opacity = '0';
          toast.style.transform = 'translateY(-10px)';
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      }

      // Set loading state for button
      function setButtonLoading(button, loading) {
        if (loading) {
          button.classList.add('btn-loading');
          button.dataset.originalText = button.innerHTML;
          button.innerHTML = '<span class="spinner"></span> Saving...';
        } else {
          button.classList.remove('btn-loading');
          if (button.dataset.originalText) {
            button.innerHTML = button.dataset.originalText;
          }
        }
      }

      // Handle API error response (structured or legacy)
      function handleApiError(response, json, context = 'Operation') {
        if (json && (json.code || json.fields)) {
          // New structured error format
          showErrorBanner(json, response.status);
        } else {
          // Legacy error format or network error
          const message = json?.message || `${context} failed (HTTP ${response.status})`;
          showErrorBanner({
            error: response.statusText || 'Error',
            message: message,
            code: json?.code || null
          }, response.status);
        }
      }

      // Dismiss error banner
      dismissErrorBtn.addEventListener('click', hideErrorBanner);

      function setSSEBadge(connected) {
        if (connected) {
          sseStatusText.textContent = 'SSE: live';
          sseStatusEl.style.background = 'rgba(16,185,129,0.16)';
        } else {
          sseStatusText.textContent = 'SSE: disconnected';
          sseStatusEl.style.background = 'rgba(248,113,113,0.12)';
        }
      }

      function clearTable() {
        flagsBody.innerHTML = `
        <tr>
          <td colspan="5">
            <div class="empty-state">
              No flags loaded yet. Create one on the right and hit <span class="code">Save flag</span>.
            </div>
          </td>
        </tr>`;
      }

      function formatDate(ts) {
        if (!ts) return '‚Äî';
        try {
          const d = new Date(ts);
          return d.toLocaleString();
        } catch {
          return ts;
        }
      }

      function shortConfig(cfg) {
        try {
          const str = JSON.stringify(cfg);
          if (str.length <= 60) return str;
          return str.slice(0, 57) + '‚Ä¶';
        } catch {
          return String(cfg);
        }
      }

      function createPillCell(text, className) {
        const td = document.createElement('td');
        const span = document.createElement('span');
        span.className = className;
        span.textContent = text;
        td.appendChild(span);
        return td;
      }

      // Debounce helper
      function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      }

      // Highlight matching text
      function highlightText(text, query) {
        if (!query) return text;
        const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
        return text.replace(regex, '<span class="highlight">$1</span>');
      }

      // Filter flags based on search and filter criteria
      function filterFlags(flags) {
        return flags.filter(flag => {
          // Environment filter
          if (flag.env !== selectedEnvironment) return false;

          // Search filter (match key or description)
          if (searchQuery) {
            const query = searchQuery.toLowerCase();
            const keyMatch = (flag.key || '').toLowerCase().includes(query);
            const descMatch = (flag.description || '').toLowerCase().includes(query);
            if (!keyMatch && !descMatch) return false;
          }

          // Status filter
          if (statusFilter === 'enabled' && !flag.enabled) return false;
          if (statusFilter === 'disabled' && flag.enabled) return false;

          // Rollout filter
          if (rolloutFilter === 'full' && flag.rollout !== 100) return false;
          if (rolloutFilter === 'partial' && (flag.rollout === 0 || flag.rollout === 100)) return false;
          if (rolloutFilter === 'off' && flag.rollout !== 0) return false;

          // Expression filter
          if (expressionFilter === 'with' && !flag.expression) return false;
          if (expressionFilter === 'without' && flag.expression) return false;

          return true;
        });
      }

      // Update environment tabs active state
      function updateEnvTabs() {
        envTabs.forEach(tab => {
          const tabEnv = tab.getAttribute('data-env');
          if (tabEnv === selectedEnvironment) {
            tab.classList.add('active');
          } else {
            tab.classList.remove('active');
          }
        });
      }

      // Load environment from localStorage or URL hash
      function loadSelectedEnvironment() {
        // Try URL hash first (e.g., #env=staging)
        const hash = window.location.hash;
        if (hash.startsWith('#env=')) {
          const envFromHash = hash.substring(5);
          if (['prod', 'staging', 'dev'].includes(envFromHash)) {
            selectedEnvironment = envFromHash;
            return;
          }
        }

        // Fall back to localStorage
        const savedEnv = localStorage.getItem('selectedEnvironment');
        if (savedEnv && ['prod', 'staging', 'dev'].includes(savedEnv)) {
          selectedEnvironment = savedEnv;
        }
      }

      // Save environment to localStorage and URL hash
      function saveSelectedEnvironment(env) {
        selectedEnvironment = env;
        localStorage.setItem('selectedEnvironment', env);
        window.location.hash = `env=${env}`;
        updateEnvTabs();
        renderSnapshot();
      }

      // Fetch audit logs
      async function fetchAuditLogs() {
        try {
          const offset = (auditCurrentPage - 1) * auditLimit;
          const url = new URL(API_BASE + '/v1/admin/audit-logs');
          url.searchParams.set('limit', auditLimit);
          url.searchParams.set('offset', offset);

          auditTimeline.innerHTML = `
            <div class="loading-spinner-container">
              <div class="loading-spinner-large"></div>
            </div>`;

          const adminKey = adminKeyInput.value.trim() || 'admin-123';
          const res = await fetch(url.toString(), {
            headers: {
              Authorization: 'Bearer ' + adminKey,
            },
          });

          if (!res.ok) {
            throw new Error('Failed to fetch audit logs: ' + res.status);
          }

          const data = await res.json();
          auditLogs = data.logs || [];
          auditTotalCount = data.total_count || 0;

          renderAuditLogs();
          updateAuditPagination();
        } catch (err) {
          console.error('audit logs error', err);
          auditTimeline.innerHTML = `
            <div class="empty-state">
              Failed to load audit logs: ${err.message}
            </div>`;
        }
      }

      // Render audit logs
      function renderAuditLogs() {
        // Apply client-side filters
        let filtered = auditLogs;

        if (auditActionFilter) {
          filtered = filtered.filter(log => log.action === auditActionFilter);
        }

        if (auditResourceFilter) {
          const query = auditResourceFilter.toLowerCase();
          filtered = filtered.filter(log => 
            (log.resource || '').toLowerCase().includes(query)
          );
        }

        if (filtered.length === 0) {
          auditTimeline.innerHTML = `
            <div class="empty-state">
              No audit logs found. ${auditActionFilter || auditResourceFilter ? 'Try different filters.' : ''}
            </div>`;
          return;
        }

        auditTimeline.innerHTML = filtered.map(log => {
          const date = new Date(log.timestamp);
          const timeStr = date.toLocaleString();
          const statusClass = log.status >= 200 && log.status < 300 ? 'success' : 'error';
          const statusText = log.status >= 200 && log.status < 300 ? `HTTP ${log.status}` : `Error ${log.status}`;

          let detailsHtml = '';
          if (log.details && Object.keys(log.details).length > 0) {
            detailsHtml = `
              <div class="audit-entry-details">
                ${Object.entries(log.details).map(([key, val]) => 
                  `<div><strong>${escapeHtml(key)}:</strong> ${escapeHtml(JSON.stringify(val))}</div>`
                ).join('')}
              </div>`;
          }

          return `
            <div class="audit-entry">
              <div class="audit-entry-header">
                <div>
                  <div class="audit-entry-time">${escapeHtml(timeStr)}</div>
                  <div class="audit-entry-action">${escapeHtml(log.action)}</div>
                  <div class="audit-entry-resource">${escapeHtml(log.resource)}</div>
                </div>
                <div class="audit-entry-status ${statusClass}">${statusText}</div>
              </div>
              ${detailsHtml}
            </div>`;
        }).join('');
      }

      // Update audit pagination
      function updateAuditPagination() {
        const totalPages = Math.ceil(auditTotalCount / auditLimit);
        auditPageInfo.textContent = `Page ${auditCurrentPage} of ${totalPages || 1}`;
        auditPrevBtn.disabled = auditCurrentPage === 1;
        auditNextBtn.disabled = auditCurrentPage >= totalPages;
      }

      // Export audit logs to CSV
      function exportAuditToCSV() {
        if (auditLogs.length === 0) {
          showToast('No audit logs to export', 'error');
          return;
        }

        const headers = ['Timestamp', 'Action', 'Resource', 'Status', 'IP Address', 'User Agent'];
        const rows = auditLogs.map(log => [
          log.timestamp,
          log.action,
          log.resource,
          log.status,
          log.ip_address,
          log.user_agent
        ]);

        const csv = [
          headers.join(','),
          ...rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
        ].join('\n');

        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `audit-logs-${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showToast('Audit logs exported successfully', 'success');
      }

      // Switch main view
      function switchMainView(view) {
        if (view === 'flags') {
          navTabFlags.classList.add('active');
          navTabAudit.classList.remove('active');
          viewFlags.classList.add('active');
          viewAudit.classList.remove('active');
        } else if (view === 'audit') {
          navTabFlags.classList.remove('active');
          navTabAudit.classList.add('active');
          viewFlags.classList.remove('active');
          viewAudit.classList.add('active');
          
          // Load audit logs when switching to audit view
          if (auditLogs.length === 0) {
            fetchAuditLogs();
          }
        }
      }

      // Update result count
      function updateResultCount(filtered, total) {
        if (filtered === total) {
          resultCount.textContent = `Showing ${total} flag${total !== 1 ? 's' : ''}`;
        } else {
          resultCount.textContent = `Showing ${filtered} of ${total} flag${total !== 1 ? 's' : ''}`;
        }
      }

      function renderSnapshot() {
        if (!currentSnapshot || !currentSnapshot.flags) {
          clearTable();
          etagValue.textContent = currentSnapshot?.etag || '‚Äî';
          updateResultCount(0, 0);
          return;
        }

        // Convert flags object to array
        const flagsArray = Object.values(currentSnapshot.flags);

        if (flagsArray.length === 0) {
          clearTable();
          etagValue.textContent = currentSnapshot.etag || '‚Äî';
          updateResultCount(0, 0);
          return;
        }

        // Apply filters
        const filteredFlags = filterFlags(flagsArray);

        if (filteredFlags.length === 0) {
          flagsBody.innerHTML = `
            <tr>
              <td colspan="5">
                <div class="empty-state">
                  No flags match your search or filters. Try different criteria.
                </div>
              </td>
            </tr>`;
          etagValue.textContent = currentSnapshot.etag || '‚Äî';
          updateResultCount(0, flagsArray.length);
          return;
        }

        flagsBody.innerHTML = '';
        etagValue.textContent = currentSnapshot.etag || '‚Äî';
        updateResultCount(filteredFlags.length, flagsArray.length);

        filteredFlags.forEach((f) => {
          const tr = document.createElement('tr');
          if (f.key === selectedKey && f.env === selectedEnv) {
            tr.classList.add('selected');
          }

          // Create key cell with highlighting
          const keyCell = document.createElement('td');
          keyCell.className = 'pill-text';
          if (searchQuery) {
            keyCell.innerHTML = highlightText(f.key, searchQuery);
          } else {
            keyCell.textContent = f.key;
          }
          tr.appendChild(keyCell);

          tr.appendChild(createPillCell(f.env, 'pill pill-env'));
          tr.appendChild(
            createPillCell(
              f.enabled ? 'Enabled' : 'Disabled',
              'pill ' + (f.enabled ? 'pill-green' : 'pill-red')
            )
          );
          tr.appendChild(createPillCell(shortConfig(f.config), 'pill-text'));

          const tdUpdated = document.createElement('td');
          tdUpdated.textContent = formatDate(f.updatedAt);
          tr.appendChild(tdUpdated);

          tr.addEventListener('click', () => {
            selectedKey = f.key;
            selectedEnv = f.env;
            fillFormFromFlag(f);
            renderSnapshot(); // refresh highlight
          });

          flagsBody.appendChild(tr);
        });
      }

      function fillFormFromFlag(flag) {
        keyInput.value = flag.key;
        envSelect.value = flag.env || 'prod';
        descInput.value = flag.description || '';
        enabledInput.checked = !!flag.enabled;
        rolloutInput.value = flag.rollout != null ? String(flag.rollout) : '100';
        try {
          configInput.value = JSON.stringify(flag.config ?? {}, null, 2);
        } catch {
          configInput.value = '{}';
        }
        selectedFlagChip.textContent = `Editing: ${flag.key} [${flag.env}]`;
        setStatus('Loaded flag into form.');
      }

      function clearForm() {
        selectedKey = null;
        selectedEnv = null;
        keyInput.value = '';
        envSelect.value = selectedEnvironment; // Use current environment tab
        descInput.value = '';
        enabledInput.checked = true;
        configInput.value = '{ "text": "Hello world" }';
        rolloutInput.value = '100';
        selectedFlagChip.textContent = 'New flag';
        hideErrorBanner();
        clearFieldErrors();
        setStatus('Ready for new flag.');
        renderSnapshot(); // clear selection highlight
      }

      async function fetchSnapshot() {
        try {
          const res = await fetch(API_BASE + '/v1/flags/snapshot');
          if (!res.ok) {
            throw new Error('snapshot ' + res.status);
          }
          currentSnapshot = await res.json();
          renderSnapshot();
          setStatus('Snapshot loaded.');
        } catch (err) {
          console.error('snapshot error', err);
          setStatus('Failed to load snapshot: ' + err.message, 'error');
        }
      }

      function attachSSE() {
        if (es) es.close();

        try {
          es = new EventSource(API_BASE + '/v1/flags/stream');
        } catch (err) {
          console.error('EventSource failed', err);
          setSSEBadge(false);
          return;
        }

        es.addEventListener('init', async (e) => {
          try {
            const data = JSON.parse(e.data || '{}');
            console.log('[admin] SSE init, etag:', data.etag || 'none');
            await fetchSnapshot();
            setSSEBadge(true);
          } catch (err) {
            console.error('SSE init error', err);
          }
        });

        es.addEventListener('update', async (e) => {
          try {
            const data = JSON.parse(e.data || '{}');
            if (typeof data.etag === 'undefined') {
              console.warn('[admin] SSE update event missing etag');
              return;
            }
            console.log('[admin] SSE update received');
            await fetchSnapshot();
          } catch (err) {
            console.error('SSE update parse error', err);
          }
        });

        es.addEventListener('open', () => {
          console.log('[admin] SSE connection opened');
          setSSEBadge(true);
        });

        es.onerror = (err) => {
          console.error('SSE error', err);
          setSSEBadge(false);
          sseStatusText.textContent = 'SSE: reconnecting‚Ä¶';
        };
      }

      // Clean up EventSource connection on page unload
      function cleanupEventSource() {
        if (es) {
          es.close();
          es = null;
        }
      }

      window.addEventListener('beforeunload', cleanupEventSource);
      window.addEventListener('pagehide', cleanupEventSource);
      window.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'hidden') {
          cleanupEventSource();
        }
      });

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        hideErrorBanner();
        clearFieldErrors();

        const key = keyInput.value.trim();
        const env = envSelect.value.trim() || 'prod';
        const desc = descInput.value.trim();
        const enabled = !!enabledInput.checked;
        const rolloutStr = rolloutInput.value.trim() || '100';
        const adminKey = adminKeyInput.value.trim();

        // Client-side validation
        const clientErrors = {};
        
        if (!key) {
          clientErrors.key = 'Key is required';
        } else if (!/^[a-zA-Z0-9_-]+$/.test(key)) {
          clientErrors.key = 'Key must contain only alphanumeric characters, underscores, and hyphens';
        } else if (key.length > 64) {
          clientErrors.key = 'Key must not exceed 64 characters';
        }
        
        if (!adminKey) {
          clientErrors.adminKey = 'Admin API key is required';
        }

        let rollout = Number(rolloutStr);
        if (!Number.isFinite(rollout) || rollout < 0 || rollout > 100) {
          clientErrors.rollout = 'Rollout must be a number between 0 and 100';
        }

        let config;
        try {
          const raw = configInput.value.trim() || '{}';
          config = JSON.parse(raw);
          if (typeof config !== 'object' || config === null || Array.isArray(config)) {
            clientErrors.config = 'Config must be a JSON object (not array, not null)';
          }
        } catch (err) {
          clientErrors.config = 'Invalid JSON: ' + err.message;
        }

        // Show client-side errors
        if (Object.keys(clientErrors).length > 0) {
          showErrorBanner({
            error: 'Validation Error',
            message: 'Please fix the errors below',
            code: 'VALIDATION_ERROR',
            fields: clientErrors
          }, 400);
          setStatus('Please fix validation errors.', 'error');
          return;
        }

        const body = {
          key,
          description: desc,
          env,
          enabled,
          rollout,
          config,
        };

        try {
          setStatus('Saving flag‚Ä¶');
          setButtonLoading(saveBtn, true);
          
          const res = await fetch(API_BASE + '/v1/flags', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: 'Bearer ' + adminKey,
            },
            body: JSON.stringify(body),
          });

          let json;
          try {
            json = await res.json();
          } catch (parseErr) {
            console.error('Failed to parse response JSON:', parseErr);
            showErrorBanner({
              error: 'Response Error',
              message: 'Invalid JSON response from server',
              code: 'PARSE_ERROR'
            }, res.status);
            setStatus('Save failed: Invalid response.', 'error');
            return;
          }

          if (!res.ok || json.ok === false) {
            handleApiError(res, json, 'Save');
            setStatus('Save failed. See error above.', 'error');
            console.error('save error', res.status, json);
            return;
          }

          const etag = json.etag || '(no etag in response)';
          // Update selected key/env to highlight the saved flag
          selectedKey = key;
          selectedEnv = env;
          hideErrorBanner();
          setStatus('Flag saved successfully!', 'success');
          showToast('Flag saved successfully!', 'success');
        } catch (err) {
          console.error('save error', err);
          // Network error
          showErrorBanner({
            error: 'Network Error',
            message: err.message || 'Could not connect to server. Please check your connection.',
            code: 'NETWORK_ERROR'
          }, 0);
          setStatus('Save failed: Connection error.', 'error');
        } finally {
          setButtonLoading(saveBtn, false);
        }
      });

      newFlagBtn.addEventListener('click', () => {
        clearForm();
      });

      const deleteFlagBtn = document.getElementById('deleteFlagBtn');
      deleteFlagBtn.addEventListener('click', async () => {
        hideErrorBanner();
        clearFieldErrors();
        
        const key = keyInput.value.trim();
        const env = envSelect.value.trim() || 'prod';
        const adminKey = adminKeyInput.value.trim();

        // Client-side validation
        const clientErrors = {};
        if (!key) {
          clientErrors.key = 'Key is required to delete a flag';
        }
        if (!adminKey) {
          clientErrors.adminKey = 'Admin API key is required';
        }

        if (Object.keys(clientErrors).length > 0) {
          showErrorBanner({
            error: 'Validation Error',
            message: 'Please fix the errors below',
            code: 'VALIDATION_ERROR',
            fields: clientErrors
          }, 400);
          setStatus('Please fix validation errors.', 'error');
          return;
        }

        // Confirmation
        const confirmMsg = `Are you sure you want to delete flag "${key}" in environment "${env}"?`;
        if (!confirm(confirmMsg)) {
          setStatus('Delete cancelled.');
          return;
        }

        try {
          setStatus('Deleting flag‚Ä¶');
          deleteFlagBtn.classList.add('btn-loading');
          
          const url = new URL(API_BASE + '/v1/flags');
          url.searchParams.set('key', key);
          url.searchParams.set('env', env);

          const res = await fetch(url.toString(), {
            method: 'DELETE',
            headers: {
              Authorization: 'Bearer ' + adminKey,
            },
          });

          let json;
          try {
            json = await res.json();
          } catch (parseErr) {
            console.error('Failed to parse response JSON:', parseErr);
            showErrorBanner({
              error: 'Response Error',
              message: 'Invalid JSON response from server',
              code: 'PARSE_ERROR'
            }, res.status);
            setStatus('Delete failed: Invalid response.', 'error');
            return;
          }

          if (!res.ok || json.ok === false) {
            handleApiError(res, json, 'Delete');
            setStatus('Delete failed. See error above.', 'error');
            console.error('delete error', res.status, json);
            return;
          }

          hideErrorBanner();
          setStatus('Flag deleted successfully!', 'success');
          showToast('Flag deleted successfully!', 'success');
          clearForm();
        } catch (err) {
          console.error('delete error', err);
          showErrorBanner({
            error: 'Network Error',
            message: err.message || 'Could not connect to server. Please check your connection.',
            code: 'NETWORK_ERROR'
          }, 0);
          setStatus('Delete failed: Connection error.', 'error');
        } finally {
          deleteFlagBtn.classList.remove('btn-loading');
        }
      });

      // Search and filter event listeners
      const debouncedSearch = debounce(() => {
        searchQuery = searchInput.value.trim();
        renderSnapshot();
      }, 300);

      searchInput.addEventListener('input', debouncedSearch);

      statusFilterSelect.addEventListener('change', () => {
        statusFilter = statusFilterSelect.value;
        renderSnapshot();
      });

      rolloutFilterSelect.addEventListener('change', () => {
        rolloutFilter = rolloutFilterSelect.value;
        renderSnapshot();
      });

      expressionFilterSelect.addEventListener('change', () => {
        expressionFilter = expressionFilterSelect.value;
        renderSnapshot();
      });

      clearFiltersBtn.addEventListener('click', () => {
        searchInput.value = '';
        searchQuery = '';
        statusFilterSelect.value = '';
        statusFilter = '';
        rolloutFilterSelect.value = '';
        rolloutFilter = '';
        expressionFilterSelect.value = '';
        expressionFilter = '';
        renderSnapshot();
      });

      // Environment tab event listeners
      envTabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const env = tab.getAttribute('data-env');
          saveSelectedEnvironment(env);
        });
      });

      // Listen for hash changes (back/forward navigation)
      window.addEventListener('hashchange', () => {
        loadSelectedEnvironment();
        updateEnvTabs();
        renderSnapshot();
      });

      // Main navigation event listeners
      navTabFlags.addEventListener('click', () => switchMainView('flags'));
      navTabAudit.addEventListener('click', () => switchMainView('audit'));

      // Audit pagination event listeners
      auditPrevBtn.addEventListener('click', () => {
        if (auditCurrentPage > 1) {
          auditCurrentPage--;
          fetchAuditLogs();
        }
      });

      auditNextBtn.addEventListener('click', () => {
        const totalPages = Math.ceil(auditTotalCount / auditLimit);
        if (auditCurrentPage < totalPages) {
          auditCurrentPage++;
          fetchAuditLogs();
        }
      });

      // Audit filter event listeners
      auditActionFilterSelect.addEventListener('change', () => {
        auditActionFilter = auditActionFilterSelect.value;
        renderAuditLogs();
      });

      const debouncedAuditResourceFilter = debounce(() => {
        auditResourceFilter = auditResourceFilterInput.value.trim();
        renderAuditLogs();
      }, 300);

      auditResourceFilterInput.addEventListener('input', debouncedAuditResourceFilter);

      clearAuditFiltersBtn.addEventListener('click', () => {
        auditActionFilterSelect.value = '';
        auditActionFilter = '';
        auditResourceFilterInput.value = '';
        auditResourceFilter = '';
        renderAuditLogs();
      });

      exportAuditBtn.addEventListener('click', exportAuditToCSV);

      (async function init() {
        // Load selected environment from localStorage/hash
        loadSelectedEnvironment();
        updateEnvTabs();
        
        await fetchSnapshot();
        attachSSE();
        clearForm(); // but keeps snapshot/table
      })();
    </script>
  </body>
</html>
