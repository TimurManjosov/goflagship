<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>go-flagship · Admin</title>
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        margin: 0;
        padding: 1.5rem;
        background: #0f172a;
        color: #e5e7eb;
      }
      h1 {
        margin-top: 0;
        font-size: 1.6rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      h1 span.logo {
        display: inline-flex;
        width: 28px;
        height: 28px;
        border-radius: 999px;
        background: radial-gradient(circle at 30% 20%, #38bdf8, #6366f1);
        align-items: center;
        justify-content: center;
        font-size: 0.9rem;
      }
      .layout {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 1.5rem;
        align-items: flex-start;
      }
      @media (max-width: 900px) {
        .layout {
          grid-template-columns: 1fr;
        }
      }
      .card {
        background: #020617;
        border-radius: 0.75rem;
        padding: 1rem 1.2rem;
        box-shadow: 0 18px 40px rgba(15, 23, 42, 0.7);
        border: 1px solid rgba(148, 163, 184, 0.15);
      }
      .card h2 {
        margin-top: 0;
        font-size: 1.1rem;
        margin-bottom: 0.6rem;
      }
      .status-bar {
        font-size: 0.85rem;
        color: #9ca3af;
        margin-bottom: 0.8rem;
        display: flex;
        justify-content: space-between;
        gap: 0.5rem;
        flex-wrap: wrap;
      }
      .pill {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.12rem 0.55rem;
        border-radius: 999px;
        background: rgba(15, 118, 110, 0.18);
        color: #a5f3fc;
        font-size: 0.75rem;
      }
      .pill-dot {
        width: 7px;
        height: 7px;
        border-radius: 999px;
        background: #22c55e;
        box-shadow: 0 0 0 5px rgba(34, 197, 94, 0.2);
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85rem;
      }
      thead {
        background: rgba(15, 23, 42, 0.8);
      }
      th,
      td {
        padding: 0.4rem 0.5rem;
        border-bottom: 1px solid rgba(31, 41, 55, 0.9);
        text-align: left;
        vertical-align: top;
      }
      th {
        font-weight: 600;
        color: #9ca3af;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }
      tr:hover td {
        background: rgba(30, 64, 175, 0.25);
      }
      code {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono',
          'Courier New', monospace;
        font-size: 0.8rem;
        padding: 0.08rem 0.3rem;
        border-radius: 0.25rem;
        background: rgba(15, 23, 42, 0.9);
        border: 1px solid rgba(55, 65, 81, 0.9);
      }
      .flag-enabled {
        color: #bbf7d0;
      }
      .flag-disabled {
        color: #fca5a5;
      }
      .badge-enabled,
      .badge-disabled {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.08rem 0.45rem;
        border-radius: 999px;
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.06em;
      }
      .badge-enabled {
        background: rgba(22, 163, 74, 0.2);
        color: #bbf7d0;
      }
      .badge-disabled {
        background: rgba(185, 28, 28, 0.2);
        color: #fecaca;
      }
      .badge-enabled span.dot,
      .badge-disabled span.dot {
        width: 6px;
        height: 6px;
        border-radius: 999px;
        background: currentColor;
      }
      .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono',
          'Courier New', monospace;
      }
      form {
        display: flex;
        flex-direction: column;
        gap: 0.6rem;
        font-size: 0.85rem;
      }
      label {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }
      input[type='text'],
      textarea,
      select {
        background: #020617;
        border-radius: 0.45rem;
        border: 1px solid rgba(75, 85, 99, 0.8);
        padding: 0.4rem 0.55rem;
        color: #e5e7eb;
        outline: none;
        font-size: 0.85rem;
      }
      input[type='checkbox'] {
        transform: scale(1.1);
      }
      input[type='text']:focus,
      textarea:focus,
      select:focus {
        border-color: #6366f1;
        box-shadow: 0 0 0 1px rgba(99, 102, 241, 0.6);
      }
      textarea {
        min-height: 110px;
        resize: vertical;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono',
          'Courier New', monospace;
      }
      button {
        border: none;
        border-radius: 999px;
        padding: 0.45rem 0.9rem;
        font-size: 0.9rem;
        cursor: pointer;
        background: linear-gradient(135deg, #4f46e5, #0ea5e9);
        color: white;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
      }
      button:disabled {
        opacity: 0.5;
        cursor: default;
      }
      .small {
        font-size: 0.75rem;
        color: #9ca3af;
      }
      .error {
        color: #fecaca;
        font-size: 0.8rem;
      }
      .success {
        color: #bbf7d0;
        font-size: 0.8rem;
      }
    </style>
  </head>
  <body>
    <h1>
      <span class="logo">fg</span>
      go-flagship · Admin
    </h1>

    <div class="layout">
      <!-- LEFT: flags table -->
      <section class="card">
        <div class="status-bar">
          <div id="status-text">Connecting…</div>
          <div class="pill">
            <span class="pill-dot"></span>
            <span id="sse-state">SSE: connecting</span>
          </div>
        </div>
        <h2>Flags</h2>
        <div class="small">
          Live snapshot from <code class="mono">/v1/flags/snapshot</code>. Updates automatically
          when <code class="mono">/v1/flags</code> changes.
        </div>
        <div style="margin-top: 0.8rem; overflow: auto; max-height: 480px">
          <table id="flags-table">
            <thead>
              <tr>
                <th>Key</th>
                <th>Env</th>
                <th>Status</th>
                <th>Config</th>
                <th>Updated</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="5" class="small">No flags loaded yet.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- RIGHT: create/update -->
      <section class="card">
        <h2>Create / Update flag</h2>
        <p class="small">
          Sends a <code class="mono">POST /v1/flags</code> request and triggers a live update via
          SSE.
        </p>

        <form id="flag-form">
          <label>
            Key
            <input id="key-input" type="text" required placeholder="e.g. banner_message" />
          </label>

          <label>
            Environment
            <input id="env-input" type="text" value="prod" required />
          </label>

          <label style="flex-direction: row; align-items: center; gap: 0.5rem">
            <input id="enabled-input" type="checkbox" checked />
            <span>Enabled</span>
          </label>

          <label>
            Config (JSON)
            <textarea id="config-input" spellcheck="false">
{ "text": "Hello world" }
          </textarea
            >
            <div class="small">
              Must be valid JSON object. Example:
              <code class="mono">{ "variant": "A", "limit": 10 }</code>
            </div>
          </label>

          <label>
            Admin API key
            <input id="admin-key-input" type="text" value="admin-123" />
            <div class="small">
              Sent as <code class="mono">Authorization: Bearer &lt;key&gt;</code>
            </div>
          </label>

          <div style="display: flex; align-items: center; gap: 0.75rem; margin-top: 0.5rem">
            <button type="submit" id="submit-btn">
              <span>Save flag</span>
            </button>
            <div id="form-message" class="small"></div>
          </div>
        </form>
      </section>
    </div>

    <script type="module">
      import { FlagshipClient } from './dist/flagshipClient.js';

      const API_BASE = 'http://localhost:8080';

      const statusText = document.getElementById('status-text');
      const sseState = document.getElementById('sse-state');
      const tableBody = document.querySelector('#flags-table tbody');
      const form = document.getElementById('flag-form');
      const keyInput = document.getElementById('key-input');
      const envInput = document.getElementById('env-input');
      const enabledInput = document.getElementById('enabled-input');
      const configInput = document.getElementById('config-input');
      const adminKeyInput = document.getElementById('admin-key-input');
      const formMsg = document.getElementById('form-message');
      const submitBtn = document.getElementById('submit-btn');

      // --- SDK client (for SSE + snapshot) ---
      const client = new FlagshipClient({ baseUrl: API_BASE });
      window.client = client; // useful for DevTools

      function setSSEState(text) {
        sseState.textContent = text;
      }

      async function fetchSnapshotDirect() {
        // Add a cache-busting param to avoid 304 from intermediary caches
        const url = new URL(`${API_BASE}/v1/flags/snapshot`);
        url.searchParams.set('ts', Date.now().toString());

        const res = await fetch(url.toString(), {
          // Avoid custom headers that trigger a CORS preflight; rely on cache: 'no-store' + ts param
          cache: 'no-store',
        });

        // Gracefully handle 304 (not modified) if some cache adds If-None-Match
        if (res.status === 304) {
          return null;
        }
        if (!res.ok) throw new Error('snapshot ' + res.status);
        return res.json();
      }

      function renderSnapshot(snapshot) {
        const flags = snapshot.flags || {};
        const keys = Object.keys(flags).sort();
        tableBody.innerHTML = '';

        if (keys.length === 0) {
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 5;
          td.textContent = 'No flags defined yet.';
          td.className = 'small';
          tr.appendChild(td);
          tableBody.appendChild(tr);
        } else {
          keys.forEach((k) => {
            const f = flags[k];
            const tr = document.createElement('tr');

            const tdKey = document.createElement('td');
            tdKey.textContent = k;
            tdKey.className = 'mono';
            tr.appendChild(tdKey);

            const tdEnv = document.createElement('td');
            tdEnv.textContent = f.env || '-';
            tdEnv.className = 'mono';
            tr.appendChild(tdEnv);

            const tdStatus = document.createElement('td');
            const badge = document.createElement('span');
            const dot = document.createElement('span');
            dot.className = 'dot';
            badge.appendChild(dot);
            badge.appendChild(document.createTextNode(f.enabled ? 'ENABLED' : 'DISABLED'));
            badge.className = f.enabled ? 'badge-enabled' : 'badge-disabled';
            tdStatus.appendChild(badge);
            tr.appendChild(tdStatus);

            const tdCfg = document.createElement('td');
            tdCfg.textContent = f.config ? JSON.stringify(f.config) : '{}';
            tdCfg.className = 'mono';
            tr.appendChild(tdCfg);

            const tdUpd = document.createElement('td');
            tdUpd.className = 'mono small';
            tdUpd.textContent = f.updated_at || f.updatedAt || '-';
            tr.appendChild(tdUpd);

            tableBody.appendChild(tr);
          });
        }

        statusText.textContent = `ETag: ${snapshot.etag || '-'} · ${keys.length} flags`;
      }

      async function reloadSnapshot() {
        try {
          const snap = await fetchSnapshotDirect();
          if (snap) {
            renderSnapshot(snap);
          }
        } catch (err) {
          console.error(err);
          statusText.textContent = 'Failed to load snapshot';
        }
      }

      // --- Form handling ---
      form.addEventListener('submit', async (ev) => {
        ev.preventDefault();
        formMsg.textContent = '';
        formMsg.className = 'small';
        submitBtn.disabled = true;

        let cfg;
        try {
          const raw = configInput.value.trim();
          cfg = raw ? JSON.parse(raw) : {};
          if (typeof cfg !== 'object' || Array.isArray(cfg)) {
            throw new Error('Config must be a JSON object');
          }
        } catch (e) {
          formMsg.textContent = 'Invalid JSON in config: ' + e.message;
          formMsg.classList.add('error');
          submitBtn.disabled = false;
          return;
        }

        const payload = {
          key: keyInput.value.trim(),
          env: envInput.value.trim(),
          enabled: !!enabledInput.checked,
          config: cfg,
        };

        try {
          const res = await fetch(`${API_BASE}/v1/flags`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: 'Bearer ' + adminKeyInput.value.trim(),
            },
            body: JSON.stringify(payload),
          });
          if (!res.ok) {
            const txt = await res.text();
            throw new Error(`HTTP ${res.status}: ${txt}`);
          }
          const data = await res.json();
          formMsg.textContent = 'Saved. New ETag: ' + (data.etag || '(none)');
          formMsg.classList.add('success');
          // Snapshot will be refreshed automatically via SSE update,
          // but we also reload once explicitly for responsiveness.
          await reloadSnapshot();
        } catch (err) {
          console.error(err);
          formMsg.textContent = 'Error: ' + err.message;
          formMsg.classList.add('error');
        } finally {
          submitBtn.disabled = false;
        }
      });

      // --- Wire up SDK events ---
      client.on('ready', async () => {
        setSSEState('SSE: connected');
        await reloadSnapshot();
      });

      client.on('update', async (etag) => {
        console.log('[admin] live update etag =', etag);
        setSSEState('SSE: live');
        await reloadSnapshot();
      });

      client.on('error', (err) => {
        console.error('[admin] SDK error', err);
        setSSEState('SSE: error');
      });

      // Initialize
      (async () => {
        try {
          await client.init();
        } catch (err) {
          console.error(err);
          statusText.textContent = 'Failed to initialize SDK';
          setSSEState('SSE: failed');
        }
      })();
    </script>
  </body>
</html>
